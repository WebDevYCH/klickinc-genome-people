{% extends "base.html" %}

{% block style %}
<link rel="canonical" href="https://demo.adminkit.io/forms-editors.html" />
<style>
    .job-details {
        height: 70px;
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden;
    }
    .other-info {
        font-size: x-small;
    }
    #people-list {
        height: 450px;
        overflow: auto;
    }
</style>
{% endblock %}
{% block app_content %}
<p class="clearfix">
    <a href="#" class="float-end text-decoration-underline ms-3">Personal Settings</a>
    <a href="#" class="float-end text-decoration-underline ms-3" id="create-job-btn" data-bs-toggle="modal" data-bs-target="#create_job_modal">Create a Job</a>
    <a href="#" class="float-end text-decoration-underline ms-3" id="available-people-btn" data-bs-toggle="modal" data-bs-target="#available_people_modal">View Available People</a>
</p>
<p id="job-num">There are {{ jobs|length }} job postings that meet the search criteria</p>
<div class="row">
    <!-- /////////////////////////// Search Criteria ///////////////////// -->
    <div class="col-12 col-xl-3">
        <form id="delta_box" class="mb-3">
            <label class="col-form-label text-sm-end pt-sm-0">Date Posted</label>
            <label class="form-check">
                <input name="delta" type="radio" class="form-check-input" value="1">
                <span class="form-check-label">Last 24 hours</span>
            </label>
            <label class="form-check">
                <input name="delta" type="radio" class="form-check-input" value="3">
                <span class="form-check-label">Last 3 days</span>
            </label>
            <label class="form-check">
                <input name="delta" type="radio" class="form-check-input" value="7" checked>
                <span class="form-check-label">Last 7 days</span>
            </label>
            <label class="form-check">
                <input name="delta" type="radio" class="form-check-input" value="30">
                <span class="form-check-label">Last 30 days</span>
            </label>
        </form>
        <div class="mb-3">
            <label class="form-label">Job Category</label>
            <select id="job-category" class="form-control mb-3">
                <option value="0" selected>Select job category</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Job Title</label>
            <select id="job-title" class="form-control mb-3">
                <option selected>Select job title</option>
                {% for title in titles %}
                <option>{{ title.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <!-- //////////////////// Job Lists ////////////////////// -->
    <div id="job-list" class="col-12 col-xl-9">
        {% for job in jobs %}
        <div class="row job-card">
            <div class="col-md-9">
                <div>
                    <span class="card-title mb-0 text-primary fs-3" job-posting-id="{{ job.id }}">{{ job.title }}</span>
                    <span class="fs-6"><i>({{ job.posted_date }} ~ <span class="card-expiry">{{ job.expiry_date }}</span>, <span class="card-category" category-id="{{ job.job_posting_category_id }}">{{ job.job_posting_category.name }}</span>)</i></span>
                </div>
                <div class="job-details">
                    Description: <span class="card-description">{{ job.description | safe }}</span>
                </div>
                <div class="other-info">
                    Skills: React.js, Node.js (To be fixed soon...)
                </div>
            </div>
            <div class="col-md-3">
                <div class="clearfix">
                    <span class="float-end ms-5 text-muted">Today</span>
                    <span class="text-success float-end">Applied</span>
                </div>
                <div class="clearfix">
                    <label class="float-end text-danger">Expires in 3 days</label>
                </div>
                {% if current_user.userid == job.poster_user_id %}
                <div class="clearfix">
                    <a href="#" class="float-end text-decoration-underline">View applicants</a>
                </div>
                <div class="clearfix">
                    <a href="#" class="float-end text-decoration-underline edit-post" data-bs-toggle="modal" data-bs-target="#create_job_modal">Edit post</a>
                </div>
                <div class="clearfix">
                    <a href="#" class="float-end text-decoration-underline">Close post</a>
                </div>
                {% endif %}
                <div class="clearfix">
                    <a href="#" class="float-end text-decoration-underline">Apply</a>
                </div>
                <div class="clearfix">
                    <a href="#" class="float-end text-decoration-underline">Cancel application</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- ///////////////////////// Create, Edit Job Modal ///////////////////////////////////////////////// -->
<div class="modal fade" id="create_job_modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create a Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body m-3">
                <div class="d-flex align-items-center modal-spinner d-none">
                    <strong>Loading...</strong>
                    <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
                </div>
                <form>
                    <label for="">Title</label>
                    <span class="text-danger">*</span>
                    <span class="text-danger d-none">This field is required!</span>
                    <select id="modal-job-title" class="form-control mb-3" required>
                        <option selected>Select job title</option>
                        {% for title in titles %}
                        <option>{{ title.name }}</option>
                        {% endfor %}
                    </select>
                    <label for="">Category</label>
                    <span class="text-danger">*</span>
                    <select id="modal-job-category" class="form-control mb-3" required>
                        <option selected>Select job posting category</option>
                        {% for category in categories %}
                        <option category-id="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                    <label for="">Job Description</label>
                    <span class="text-danger">*</span>
                    <div class="clearfix mb-3">
                        <div id="quill-toolbar">
                            <span class="ql-formats">
                                <select class="ql-font"></select>
                                <select class="ql-size"></select>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-bold"></button>
                                <button class="ql-italic"></button>
                                <button class="ql-underline"></button>
                                <button class="ql-strike"></button>
                            </span>
                            <span class="ql-formats">
                                <select class="ql-color"></select>
                                <select class="ql-background"></select>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-script" value="sub"></button>
                                <button class="ql-script" value="super"></button>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-header" value="1"></button>
                                <button class="ql-header" value="2"></button>
                                <button class="ql-blockquote"></button>
                                <button class="ql-code-block"></button>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-list" value="ordered"></button>
                                <button class="ql-list" value="bullet"></button>
                                <button class="ql-indent" value="-1"></button>
                                <button class="ql-indent" value="+1"></button>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-direction" value="rtl"></button>
                                <select class="ql-align"></select>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-link"></button>
                                <button class="ql-image"></button>
                                <button class="ql-video"></button>
                            </span>
                            <span class="ql-formats">
                                <button class="ql-clean"></button>
                            </span>
                        </div>
                        <div id="quill-editor"></div>
                    </div>
                    <label for="">Expiry Date</label>
                    <span class="text-danger">*</span>
                    <input type="text" id="expiry_date" class="form-control flatpickr-minimum mb-3"  placeholder="Select expiry date..." required />
                    <input type="hidden" id="poster_id" value="{{ current_user.userid }}">
                    <input type="hidden" id="job_posting_id">
                    <span id="job-post-btn" class="btn btn-primary float-end ms-3">Submit</span>
                    <button type="button" class="btn btn-secondary float-end" data-bs-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ////////////////// Available People Modal //////////////////////// -->
<div class="modal fade" id="available_people_modal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Available People</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body m-3">
                <div class="d-flex align-items-center modal-spinner d-none">
                    <strong>Loading...</strong>
                    <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
                </div>
                <p id="people-num"></p>
                <div class="row">
                    <div class="col-12 col-xl-4">
                        <div class="mb-3">
                            <label class="form-label">CST</label>
                            <select id="people-cst" class="form-control mb-3">
                                <option selected>Select CST</option>
                                {% for cst in csts %}
                                <option>{{ cst }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Job Function</label>
                            <select id="people-job-function" class="form-control mb-3">
                                <option selected>Select job function</option>
                                {% for jobfunction in jobfunctions %}
                                <option>{{ jobfunction }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div id="people-list" class="col-12 col-xl-8">
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    var editor;
    var category_id = 0;
    var flag = "create";
    //////////// Search Job Functions ////////////////
    $("#delta_box").change(function() {
        loading();
        let data = {
            title: $("#job-title").val(),
            category_id: category_id,
            delta: $("input[name='delta']:checked").val()
        }
        search_jobs(data);
    });
    $("#job-category").change(function() {
        loading();
        category_id = $(this).children(":selected").attr("value");
        let data = {
            title: $("#job-title").val(),
            category_id: category_id,
            delta: $("input[name='delta']:checked").val()
        }
        search_jobs(data);
    });
    $("#job-title").change(function() {
        loading();
        let data = {
            title: $(this).val(),
            category_id: category_id,
            delta: $("input[name='delta']:checked").val()
        }
        search_jobs(data);
    })
    function search_jobs(data) {
        $.ajax({
            url: "/jobsearch",
            method: "POST",
            data: data,
            success: function(res) {
                var jobs = JSON.parse(res);
                var data = "";
                jobs.forEach(job => {
                    var current_user_id = "{{ current_user.userid }}";
                    data += `<div class="row job-card">
                                <div class="col-md-9">
                                    <div>
                                        <span class="card-title mb-0 text-primary fs-3" job-posting-id="`+job.id+`">`+job.title+`</span>
                                        <span class="fs-6">(`+job.posted_date+` ~ <span class="card-expiry">`+job.expiry_date+`</span>, <span class="card-category" category-id="`+job.job_posting_category_id+`">Full Time</span>)</span>
                                    </div>
                                    <div class="job-details">
                                        Description: <span class="card-description">`+job.description+`</span>
                                    </div>
                                    <div class="other-info">
                                        Skills: Python, React.js, Node.js...
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div>
                                        <span class="float-end ms-5 text-muted">Today</span>
                                        <span class="text-success float-end">Applied</span>
                                    </div>
                                    <div class="clearfix">
                                        <label class="float-end text-danger">Expires in 3 days</label>
                                    </div>
                                    <div class="clearfix">
                                        <a href="#" class="float-end text-decoration-underline">View applicants</a>
                                    </div>
                                    ` + (current_user_id == job.poster_user_id ? `
                                    <div class="clearfix">
                                        <a href="#" class="float-end text-decoration-underline edit-post" data-bs-toggle="modal" data-bs-target="#create_job_modal">Edit post</a>
                                    </div>
                                    <div class="clearfix">
                                        <a href="#" class="float-end text-decoration-underline">Close post</a>
                                    </div>` : '') + `
                                    <div class="clearfix">
                                        <a href="#" class="float-end text-decoration-underline">Apply</a>
                                    </div>
                                    <div class="clearfix">
                                        <a href="#" class="float-end text-decoration-underline">Cancel application</a>
                                    </div>
                                </div>
                            </div>`;
                });
                $("#job-list").html(data);
                $("#job-num").html("There are "+jobs.length+" job postings that meet the search criteria");
                unloading();
            }
        });
    }
    ////////////// Widgets Ready ///////////////////////////
    document.addEventListener("DOMContentLoaded", function() {
		flatpickr(".flatpickr-minimum", {
            minDate: "today"
        });
        editor = new Quill("#quill-editor", {
            modules: {
                toolbar: "#quill-toolbar"
            },
            placeholder: "Write job description here...",
            theme: "snow"
        });
    });
    //////////// Job Post, Edit Functions /////////////
    $('#job-post-btn').on('click', function() {
        var description = editor.root.innerHTML;
        var title = $('#modal-job-title').val();
        var poster_id = $("#poster_id").val();
        var expiry_date = $("#expiry_date").val();
        var category = $("#modal-job-category").val();
        var job_posting_id = $("#job_posting_id").val();
        if(title == "Select job title" || category == "Select job posting category" || description == "<p><br></p>" || expiry_date == "") {
            alert("You must fill required fields!");
        } else {
            $("#create_job_modal").modal('hide');
            if (flag == "create") {
                var url = '{{ url_for("postjob") }}';
            }
            else {
                var url = '{{ url_for("editjob") }}';
            }
            $.ajax({
                type: 'POST',
                url: url,
                data: {
                    title: title,
                    category_id: category_id,
                    description: description,
                    poster_id: parseInt(poster_id),
                    expiry_date: expiry_date,
                    job_posting_id: job_posting_id
                },
                success: function() {
                    loading();
                    window.location.href = '/jobsearch';
                }
            });
            unloading();
        }
    });
    $("#modal-job-category").change(function() {
        category_id = $(this).children(":selected").attr("category-id");
    });
    $("#job-list").on("click", ".edit-post", function() {
        flag = "edit";
        category_id = $(this).closest('.job-card').find('.card-category').attr('category-id');
        let title = $(this).closest('.job-card').find('.card-title').html();
        let category = $(this).closest('.job-card').find('.card-category').html();
        let description = $(this).closest('.job-card').find('.card-description').html();
        let expiry = $(this).closest('.job-card').find('.card-expiry').html();
        let job_posting_id = $(this).closest('.job-card').find('.card-title').attr('job-posting-id');
        $("#modal-job-title").val(title);
        $("#modal-job-category").val(category);
        editor.root.innerHTML = description;
        $("#expiry_date").val(expiry);
        $("#job_posting_id").val(job_posting_id);
        $(".modal-title").html("Edit a Job");
    });
    $("#create-job-btn").click(function() {
        flag = "create";
        category_id = 0;
        $("#modal-job-title").val("Select job title");
        $("#modal-job-category").val("Select job posting category");
        editor.root.innerHTML = "<p><br></p>";
        $("#expiry_date").val("");
        $("#job_posting_id").val("");
        $(".modal-title").html("Create a Job");
    });
    //////////////////// Available People Functions ///////////
    $("#available-people-btn").click(function() {
        showModalLoading();
        let data = {
            cst: $("#people-cst").val(),
            jobfunction: $("#people-job-function").val()
        }
        searchpeople(data);
    });
    $("#people-cst").change(function() {
        showModalLoading();
        let data = {
            cst: $(this).val(),
            jobfunction: $("#people-job-function").val()
        }
        searchpeople(data);
    });
    
    $("#people-job-function").change(function() {
        showModalLoading();
        let data = {
            cst: $("#people-cst").val(),
            jobfunction: $(this).val()
        }
        searchpeople(data);
    });
    function searchpeople(data) {
        $.ajax({
            url: "{{ url_for('searchpeople') }}",
            method: "POST",
            data: data,
            success: function(response) {
                var html_str = "";
                var people = JSON.parse(response);
                people.forEach(p => {
                    html_str += `
                        <div class="row people-card">
                            <div class="col-12">
                                <div>
                                    <span class="card-title mb-0 text-primary fs-4">`+p.firstname+` `+p.lastname+`</span>
                                </div>
                                <div class="other-info">
                                    `+p.cst+` `+p.jobfunction+`
                                </div>
                                <div class="clearfix">
                                    <a href="#" class="float-end text-decoration-underline">View profile</a>
                                </div>
                            </div>
                        </div>
                    `;
                    $("#people-num").html("There are "+people.length+" people that meet the criteria");
                    $("#people-list").html(html_str);
                    hideModalLoading();
                });
            }
        });
    }
</script>
{% endblock %}
