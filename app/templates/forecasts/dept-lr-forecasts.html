{% extends "forecasts/portfolio-forecasts.html" %}

<script language="javascript">
{% block layout %}
const layout = new dhx.Layout("layout", {
    rows: [
        { id: "yearcombo", width: "300px" },
        { id: "lrcatcombo", width: "300px" },
        {
            cols: [
                { id: "cstcombo", width: "300px" },
                { id: "or", html: "<i>or</i>", padding: "30px" },
                { id: "clientcombo", width: "600px" },
                { id: "blank", gravity: 100 },
            ],
            height: "content",
            align: "left",
        },
        { id: "checkboxformcontainer", html: '<form id="form"></form>' },
        { id: "note", html: "Forecasts in <i>italics</i> come at least partially from machine forecasts and <b>bold</b> are fully PM overrides</i>" },
        { id: "treegrid" },
    ]
});
{% endblock %}

{% block yearcomboonchange %}
yearcomboonchange = function(id) {
    var year = yearcombo.getValue();
    if (year == "") return;
    cstcombo.data.removeAll();
    cstcombo.data.load('/forecasts/cst-list?year='+year);
    clientcombo.data.removeAll();
    clientcombo.data.load('/forecasts/client-list?year='+year);
    lrcatcombo.data.removeAll();
    lrcatcombo.data.load('/forecasts/lrcat-list?year='+year);
}
yearcombo.events.on("change", yearcomboonchange);
setTimeout(yearcomboonchange, 0);
{% endblock %}

{% block cstcomboonchange %}
cstcomboonchange = function(id) {
    var year = yearcombo.getValue();
    var csts = cstcombo.getValue();
    var lrcat = lrcatcombo.getValue();
    if (csts != "") {
        treegrid.data.removeAll();
        treegrid.data.load('dept-lr-forecasts-data?year='+year+'&lrcat='+lrcat+'&csts='+csts);
        loading();
    }
}
{% endblock %}

{% block clientcomboonchange %}
clientcomboonchange = function(id) {
    var year = yearcombo.getValue();
    var clients = clientcombo.getValue();
    var lrcat = lrcatcombo.getValue();
    if (clients != "") {
        treegrid.data.removeAll();
        treegrid.data.load('dept-lr-forecasts-data?year='+year+'&lrcat='+lrcat+'&clients='+clients);
        loading();
    }
}
{% endblock %}

{% block treegridcelltemplate %}
treegridcelltemplate = function(text, row, col) {
    if (text && row.id.endsWith("SUMMARY") && col.id.startsWith("m") && row[col.id + '-source'] != 'MAIN') {
        return "<i>"+text+"</i><span style='width:3px'></span>";
    }
    else if (text && row.id.endsWith("SUMMARY") && col.id.startsWith("m") && row[col.id + '-source'] == 'MAIN') {
        return "<b>"+text+"</b>";
    }
    else {
        return text;
    }
}
{% endblock %}

{% block jsinit %}
const lrcatcombo = new dhx.Combobox(null, {
    multiselection: false,
    readOnly: true,
    label: "Labor Category (req'd)",
});
lrcatcomboonchange = function(id) {
    var year = yearcombo.getValue();
    var lrcat = lrcatcombo.getValue();
    var csts = cstcombo.getValue();
    var clients = clientcombo.getValue();
    var showportfolios = form.getItem("showportfolios").getValue();
    var showsources = form.getItem("showsources").getValue();
    if (lrcat != "") {
        treegrid.data.removeAll();
        loading();
        if (csts != "")
            treegrid.data.load('dept-lr-forecasts-data?year='+year+'&lrcat='+lrcat+'&csts='+csts+'&showportfolios='+showportfolios+'&showsources='+showsources);
        else if (clients != "")
            treegrid.data.load('dept-lr-forecasts-data?year='+year+'&lrcat='+lrcat+'&clients='+clients+'&showportfolios='+showportfolios+'&showsources='+showsources);
        else
            treegrid.data.load('dept-lr-forecasts-data?year='+year+'&lrcat='+lrcat+'&showportfolios='+showportfolios+'&showsources='+showsources);
    }
}
lrcatcombo.events.on("change", lrcatcomboonchange);
layout.getCell("lrcatcombo").attach(lrcatcombo);

const form = new dhx.Form("form", {
    width: "300px",
    height: "100%",
    rows: [
        { id: "showportfolios", type: "checkbox", label: "Show Portfolios", labelWidth: "150px", labelPosition: "left", disabled: false, required: false, hidden: false, helpMessage: "Show portfolios under labor roles" },
        { id: "showsources", type: "checkbox", label: "Show Sources", labelWidth: "150px", labelPosition: "left", disabled: false, required: false, hidden: false, helpMessage: "Show the source of each forecast; rendering will take a while" },
    ]
});
form.events.on("change", lrcatcomboonchange);
{% endblock %}


</script>